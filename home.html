<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

<script>
    // ১. আপনার ফায়ারবেস কনফিগারেশন
    const firebaseConfig = {
        apiKey: "AIzaSyDRwrekZBZ31ACszDk2EJM_IqxRRwaGfCg",
        authDomain: "bd-marketing-55a81.firebaseapp.com",
        databaseURL: "https://bd-marketing-55a81-default-rtdb.firebaseio.com",
        projectId: "bd-marketing-55a81",
        storageBucket: "bd-marketing-55a81.firebasestorage.app",
        messagingSenderId: "678696512628",
        appId: "1:678696512628:web:edfc22a62f55dad41df521"
    };

    // ফায়ারবেস ইনিশিয়ালাইজেশন
    if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
    }
    const auth = firebase.auth();
    const db = firebase.database();

    // ২. রিয়েল-টাইম ইউজার কন্ট্রোল ইঞ্জিন
    auth.onAuthStateChanged((user) => {
        if (user) {
            // ডাটাবেস থেকে ইউজারের Saddam বা Saddam15 আইডি শনাক্ত করা
            const userPath = user.displayName ? user.displayName.replace(/\s+/g, '_') : "Admin_User";
            
            db.ref('Users/' + userPath).on('value', (snapshot) => {
                const userData = snapshot.val();
                
                if (userData) {
                    // UI আপডেট (নাম গোপন রেখে এডমিন দেখানো)
                    updateUI(userData);

                    // ভেরিফিকেশন এবং স্ট্যাটাস চেক
                    if (userData.status === "Active") {
                        if (Swal.isVisible()) Swal.close(); // একটিভ হলে পপ-আপ বন্ধ হবে
                    } else {
                        showLockPopup(); // একটিভ না হলে লক থাকবে
                    }
                } else {
                    showLockPopup(); // ডাটা না থাকলে লক থাকবে
                }
            });
        } else {
            // সেশন শেষ হলে লগইন পেজে রিডাইরেক্ট
            window.location.href = "index.html";
        }
    });

    // ৩. UI আপডেট ফাংশন (কাস্টমাইজযোগ্য)
    function updateUI(data) {
        document.getElementById('user-balance').innerText = data.balance || "0.00";
        document.getElementById('pending-val').innerText = data.pending || "0.00";
        document.getElementById('display-user').innerText = "স্বাগতম এডমিন"; 
        console.log("সিস্টেম: ডাটাবেস সিঙ্ক সফল।");
    }

    // ৪. প্রোটেকশন গেট (পপ-আপ)
    function showLockPopup() {
        Swal.fire({
            title: 'অ্যাক্সেস সংরক্ষিত!',
            text: 'আপনার প্রোফাইলটি এখনো অনুমোদিত নয়। এডমিনের অনুমতির অপেক্ষা করুন।',
            icon: 'lock',
            confirmButtonText: 'রেজিস্ট্রেশন চেক',
            confirmButtonColor: '#1f6feb',
            background: '#0d1117',
            color: '#fff',
            allowOutsideClick: false
        }).then((result) => {
            if (result.isConfirmed) window.location.href = "index.html";
        });
    }

    // ৫. সিকিউর লগআউট
    function logout() {
        auth.signOut().then(() => {
            localStorage.clear();
            window.location.href = "index.html";
        });
    }

    // ৬. গ্লোবাল জব লোডার
    function loadGlobalJobs() {
        db.ref('GlobalJobs').on('value', (snap) => {
            const jobs = snap.val();
            const container = document.getElementById('market-display');
            if (jobs) {
                let jobHtml = '<div class="space-y-4">';
                Object.keys(jobs).forEach(id => {
                    const j = jobs[id];
                    jobHtml += `
                        <div class="master-panel p-4 border-gray-800 flex justify-between items-center">
                            <div>
                                <h4 class="font-bold text-sm text-white">${j.title}</h4>
                                <p class="text-[10px] text-blue-500">পারিশ্রমিক: ৳ ${j.pay}</p>
                            </div>
                            <button onclick="window.open('${j.link}', '_blank')" class="bg-blue-600 text-[10px] px-3 py-2 rounded-lg font-bold">কাজ দেখুন</button>
                        </div>`;
                });
                jobHtml += '</div>';
                container.innerHTML = jobHtml;
            }
        });
    }

    // পেজ রেডি হলে ফাংশন কল
    window.onload = function() {
        loadGlobalJobs();
    };
</script>

